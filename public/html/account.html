<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/account.css">
  <!-- COPY BELOW TO ALL OTHER PAGE HTML HEADS -->
  <!-- <link rel="stylesheet" href="../css/global.css"> -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caprasimo&family=Quicksand:wght@300..700&display=swap" rel="stylesheet"> 
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <title><Hello World/> Park</title>
</head>
<body>
    <script src="../js/modal.js"></script>
    <script>
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            // console.log(email, password)
            try {
                const response = await fetch('http://localhost:3000/account', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const results = await response.json();
                if (results.success) {
                    const dataDiv = document.getElementById('results')
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'name-wrapper';
                    nameDiv.innerHTML = `<div>
                                            <span class='name-header'>Welcome, ${results.data[0].first_name}!</span>
                                            <br>
                                            <p style='padding-left: 5px;'>Past Purchases<p>
                                        </div>
                                        <div>
                                            <button class='update-info-btn'>Update My Info</button>
                                        </div>`;
                    dataDiv.appendChild(nameDiv);
                    const ordersDiv = document.createElement('div')
                    ordersDiv.className = "order-wrapper";
                    results.data.forEach((row , index)=> {
                        const orderId = row.order_id;
                        const purchaseDate = row.purchase_date;
                        const products = row.products.split(',');
                        
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'order-list-wrapper';

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'order-items-wrapper';
                        const isLastItem = index === results.data.length - 1;

                        itemDiv.innerHTML = `<h3>Order #${orderId}</h3>
                                            <p>${purchaseDate}</p>`;
                        products.forEach(elem => {
                            const quantity = elem[elem.length-1];
                            const product = elem.substring(0, elem.length-1);

                            itemDiv.innerHTML += `<p>x ${quantity} ${product}</p>`;
                        })

                        


                        rowDiv.append(itemDiv)


                        const cancelBtnDiv = document.createElement('div');
                        cancelBtnDiv.className = 'cancel-btn-wrapper';
                        cancelBtnDiv.innerHTML = `<button class='cancel-btn' onclick='openCancelModal(${orderId})'>Cancel</button>`;
                        
                        const modalDiv = document.createElement('div');
                        modalDiv.className = 'modal';
                        modalDiv.id = 'cancelModal';
                        modalDiv.innerHTML = `
                            <div class='modal-content'>
                                <h1 id='modalTitle'></h1>
                                <p id='modalDesc'>Are you sure you want to cancel your order?<br>This action cannot be undone.</p>
                                <button onclick=''>CANCEL MY ORDER</button>
                            </div>`;

                        rowDiv.append(cancelBtnDiv);

                        ordersDiv.appendChild(rowDiv);
                        ordersDiv.appendChild(modalDiv);

                        if (!isLastItem) {
                            ordersDiv.innerHTML += `<div class='divider'></div>`;
                        }
                        
                    });
                    dataDiv.appendChild(ordersDiv);
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('results').style.display = 'flex';
                    document.getElementById('results').style.flexDirection = 'column';
                    document.getElementById('results').style.justifyContent = 'center'; 


                } else { alert(results.message) };
            } catch (error) { console.error('Error logging in: ', error); }
        }
    </script>
  <div class="shop">
    <header>
        <nav>
            <ul>
                <li>
                    <a href="/"><div class="back-container">
                        <img class="left-caret" src="../assets/svg/left-caret.svg"/>
                        <p>Back to site</p>
                    </div></a>
                    <div class="line-5"></div>
                </li>
                <li>
                    <div class="logo-container">
                        <img class="logo" src="../assets/img/logo.png" alt="hello world logo">
                        <span>MY ACCOUNT</span>
                    </div>
                </li>
                <li><a href="/checkout"><img src="../assets/svg/cart.svg" alt="cart svg"></a></li>
                <li><a href="/account"><img src="../assets/svg/account.svg" alt="account svg"></a></li>
            </ul>
        </nav>
      </header>
    <main>
        <div id="loginForm" class="login-wrapper">
            <h2>Welcome Back!</h2>
            <p>Email</p>
            <input type="text" name="email" id="email" placeholder="" required>
            <p>Password</p>
            <input type="password" name="password" id="password" placeholder="" required>
            <br><br>
            <button onclick="login()">Login</button>
        </div>
        <div id="results" class="user-info-container">
            <!-- <h2>Welcome, <span id="firstName"></span></h2>
            <p><span id="email"></span></p>
            <h3>Past Purchases</h3>
            <div id="results"></div> -->
        </div>

        

    </main>
  </div>
  
</body>
</html>